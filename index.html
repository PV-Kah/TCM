<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dịch Config</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <style>
        body {
            padding: 20px;
        }
        #resultText {
            min-height: 200px;
        }
        .footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            height: 60px;
        }
        .loading-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .loading-popup .content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .loading-popup .loading-image {
            margin-bottom: 10px;
        }
        .download-button {
            margin-top: 10px;
            position: relative;
            z-index: 1;
        }

        #progressBar {
            margin-top: 20px;
            height: 20px;
        }

        #progressMessage {
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dịch Config</h1>
        <p>Chỉ Dịch File Language (Ngôn Ngữ)</p>
        <p>LƯU Ý: SAU KHI DỊCH XONG FILE MÀ MUỐN DỊCH TIẾP THÌ VUI LÒNG TẢI LẠI TRANG</p>

        <div class="form-group">
            <label for="configInput">Paste Config vào đây:</label>
            <textarea class="form-control" id="configInput" rows="5"></textarea>
        </div>
        <br>
        <p>HOẶC</p>
        <div class="custom-file mb-3">
            <input type="file" class="custom-file-input" id="configFile" name="configFile">
            <label class="custom-file-label" for="configFile">Bấm Vào Đây Để Chọn File | Kéo File Vào Đây</label>
        </div>
        <button id="button" class="btn btn-primary mb-3">Dịch</button>
        <div class="loading-popup" id="loadingPopup" style="display: none;">
            <div class="content">
                <img src="https://media.tenor.com/On7kvXhzml4AAAAj/loading-gif.gif" width="50px" class="loading-image" alt="Loading...">
                <div class="loading-message">Đang dịch...</div>
            </div>
        </div>
        
        <div id="progressBar" class="progress" style="display: none;">
            <div id="progress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;"></div>
        </div>
        <div id="progressMessage"></div>

        <textarea id="resultText" class="form-control" placeholder="Translated text will appear here..." style="display: none;"></textarea>
        <a href="#" class="btn btn-success download-button" id="downloadButton" style="display: none;">Tải File Dịch</a>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
    <script>
        $('#button').click(function(){
            var configText = $('#configInput').val();
            var file = document.getElementById('configFile').files[0];
            
            if (configText) {
                $('#loadingPopup').show();
                $('#progressBar').show();
                setTimeout(function() {
                    $('#loadingPopup').hide();
                    var translatedText = translate(configText);
                    $('textarea#resultText').val(translatedText).show();
                    $('#downloadButton').attr('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(translatedText)).attr('download', 'translated_config.txt');
                    $('#downloadButton').show();
                }, 500); 
            }

            if (file) {
                var reader = new FileReader();
                reader.readAsText(file, "UTF-8");
                reader.onload = function (evt) {
                    $('#loadingPopup').show();
                    $('#progressBar').show();
                    setTimeout(function() {
                        $('#loadingPopup').hide();
                        var translatedText = translate(evt.target.result);
                        $('textarea#resultText').val(translatedText).show();
                        $('#downloadButton').attr('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(translatedText)).attr('download', file.name);
                        $('#downloadButton').show();
                    }, 500);
                }
            }
        });

        function translate(sourceText) {
            var sourceLang = 'en';
            var targetLang = 'vi';
            var matches = sourceText.match(/.*: (.*)/g);
            if (!matches) return;
            var translationsDone = 0;
            var translatedText = sourceText;

            matches.forEach(function(match) {
                var textToTranslate = match.match(/: (.*)/)[1];
                
                // Kiểm tra điều kiện bỏ qua việc dịch nếu là từ khóa không cần dịch
                if (textToTranslate.trim() === 'true' || textToTranslate.trim() === 'false' || textToTranslate.trim() === 'disabled' || textToTranslate.trim() === 'enabled') {
                    translationsDone++;
                    return;
                }
                if (textToTranslate.startsWith('&') && /^\d+$/.test(textToTranslate.substr(1))) {
                    translationsDone++;
                    return;
                }
                if (textToTranslate.includes('<pos>')) {
                    translationsDone++;
                    return;
                }
                if (/^[A-Z]/.test(textToTranslate)) {
                    translationsDone++;
                    return;
                }

                var innerTranslation = '';
                var outerText = textToTranslate.replace(/(\&\&.*?\&\&)/g, function(match) {
                    innerTranslation = match;
                    return '';
                });

                // Chia phần văn bản để dịch
                var parts = outerText.split(/(&\w)/);
                
                parts.forEach(function(part, index) {
                    if (!part.startsWith('&') && part !== '%%' && !/prefix/i.test(part)) {
                        var url = "https://translate.googleapis.com/translate_a/single?client=gtx&sl=" + sourceLang + "&tl=" + targetLang + "&dt=t&q=" + encodeURI(part);
                        $.ajax({
                            url: url,
                            success: function(data) {
                                var translatedValue = data[0][0][0];
                                parts[index] = translatedValue;
                                translationsDone++;

                                // Cập nhật thanh tiến độ
                                var progress = Math.round((translationsDone / matches.length) * 100);
                                $('#progress').css('width', progress + '%');
                                $('#progressMessage').text(progress + "%");

                                // Khi tất cả đã được dịch, ẩn thông báo tải
                                if(translationsDone === matches.length) {
                                    $('#loadingPopup').hide();
                                }
                            },
                            async: false
                        });
                    }
                });

                var fullTranslatedValue = parts.join('');
                fullTranslatedValue = fullTranslatedValue.replace(/\[pos\]/g, '<pos>');
                fullTranslatedValue = fullTranslatedValue.replace(/\[(\d)\]/g, '{$1}');

                if (innerTranslation) {
                    fullTranslatedValue += ' ' + innerTranslation;
                }

                translatedText = translatedText.replace(textToTranslate, fullTranslatedValue);
            });

            return translatedText;
        }
    </script>
</body>
</html>
